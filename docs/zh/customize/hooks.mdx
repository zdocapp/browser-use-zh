---
title: "生命周期钩子"
description: "使用生命周期钩子自定义代理行为"
icon: "Wrench"
mode: "wide"
---

Browser-Use 提供生命周期钩子，允许您在代理执行过程中的特定点执行自定义代码。
钩子函数可用于在运行时读取和修改代理状态、实现自定义逻辑、更改配置、将代理与外部应用程序集成。

## 可用钩子

目前，Browser-Use 提供以下钩子：

| 钩子            | 描述                                       | 调用时机                                                                                          |
| --------------- | ------------------------------------------ | ------------------------------------------------------------------------------------------------- |
| `on_step_start` | 在每个代理步骤开始时执行                   | 在代理处理当前状态并决定下一个操作之前                                                              |
| `on_step_end`   | 在每个代理步骤结束时执行                   | 在代理执行完当前步骤的所有操作之后，开始下一个步骤之前                                              |

```python
await agent.run(on_step_start=..., on_step_end=...)
```

每个钩子应该是一个 `async` 可调用函数，接受 `agent` 实例作为其唯一参数。

### 基础示例

```python
import asyncio
from pathlib import Path

from browser_use import Agent, ChatOpenAI
from browser_use.browser.events import ScreenshotEvent


async def my_step_hook(agent: Agent):
	# inside a hook you can access all the state and methods under the Agent object:
	#   agent.settings, agent.state, agent.task
	#   agent.tools, agent.llm, agent.browser_session
	#   agent.pause(), agent.resume(), agent.add_new_task(...), etc.

	# You also have direct access to the browser state
	state = await agent.browser_session.get_browser_state_summary()

	current_url = state.url
	visit_log = agent.history.urls()
	previous_url = visit_log[-2] if len(visit_log) >= 2 else None
	print(f'Agent was last on URL: {previous_url} and is now on {current_url}')
	cdp_session = await agent.browser_session.get_or_create_cdp_session()

	# Example: Get page HTML content
	doc = await cdp_session.cdp_client.send.DOM.getDocument(session_id=cdp_session.session_id)
	html_result = await cdp_session.cdp_client.send.DOM.getOuterHTML(
		params={'nodeId': doc['root']['nodeId']}, session_id=cdp_session.session_id
	)
	page_html = html_result['outerHTML']

	# Example: Take a screenshot using the event system
	screenshot_event = agent.browser_session.event_bus.dispatch(ScreenshotEvent(full_page=False))
	await screenshot_event
	result = await screenshot_event.event_result(raise_if_any=True, raise_if_none=True)

	# Example: pause agent execution and resume it based on some custom code
	if '/finished' in current_url:
		agent.pause()
		Path('result.txt').write_text(page_html)
		input('Saved "finished" page content to result.txt, press [Enter] to resume...')
		agent.resume()


async def main():
	agent = Agent(
		task='Search for the latest news about AI',
		llm=ChatOpenAI(model='gpt-5-mini'),
	)

	await agent.run(
		on_step_start=my_step_hook,
		# on_step_end=...
		max_steps=10,
	)


if __name__ == '__main__':
	asyncio.run(main())
```

## 钩子中可用的数据

在使用代理钩子时，您可以访问整个 `Agent` 实例。以下是一些您可以访问的有用数据点：

- `agent.task` 允许您查看主要任务，`agent.add_new_task(...)` 允许您排队新任务
- `agent.tools` 提供对 `Tools()` 对象和包含可用操作的 `Registry()` 的访问权限
  - `agent.tools.registry.execute_action('click_element_by_index', {'index': 123}, browser_session=agent.browser_session)`
- `agent.context` 允许您访问传递给 `Agent(context=...)` 的任何用户提供的上下文对象
- `agent.sensitive_data` 包含敏感数据字典，可以就地更新以添加/删除/修改项目
- `agent.settings` 包含初始化时传递给 `Agent(...)` 的所有配置选项
- `agent.llm` 提供对主 LLM 对象（例如 `ChatOpenAI`）的直接访问
- `agent.state` 提供对大量内部状态的访问，包括代理思考、输出、操作等
- `agent.history` 提供对代理执行历史数据的访问：
  - `agent.history.model_thoughts()`: Browser Use 模型的推理过程
  - `agent.history.model_outputs()`: Browser Use 模型的原始输出
  - `agent.history.model_actions()`: 代理执行的操作
  - `agent.history.extracted_content()`: 从网页提取的内容
  - `agent.history.urls()`: 代理访问的 URL
- `agent.browser_session` 提供对 `BrowserSession` 和 CDP 接口的直接访问
  - `agent.browser_session.agent_focus`: 获取代理当前关注的 CDP 会话
  - `agent.browser_session.get_or_create_cdp_session()`: 获取用于浏览器交互的当前 CDP 会话
  - `agent.browser_session.get_tabs()`: 获取当前打开的所有标签页
  - `agent.browser_session.get_current_page_url()`: 获取当前活动标签页的 URL
  - `agent.browser_session.get_current_page_title()`: 获取当前活动标签页的标题

## 使用钩子的技巧

- **避免阻塞操作**：由于钩子与代理在同一执行线程中运行，请保持其高效性并避免阻塞操作。
- **优先使用自定义工具**：钩子属于较为高级的功能，大多数需求可以通过[自定义工具](/customize/tools/basics)实现
- **增加步骤超时时间**：如果钩子需要执行耗时操作，可以在 `Agent(...)` 构造函数中增加 `step_timeout` 参数

---
